var d=({onSseError:c,onSseEvent:r,responseTransformer:f,responseValidator:O,sseDefaultRetryDelay:b,sseMaxRetryAttempts:m,sseMaxRetryDelay:u,sseSleepFn:x,url:h,...$})=>{let S,W=x??((N)=>new Promise((z)=>setTimeout(z,N)));return{stream:async function*(){let N=b??3000,z=0,Y=$.signal??new AbortController().signal;while(!0){if(Y.aborted)break;z++;let E=$.headers instanceof Headers?$.headers:new Headers($.headers);if(S!==void 0)E.set("Last-Event-ID",S);try{let J=await fetch(h,{...$,headers:E,signal:Y});if(!J.ok)throw new Error(`SSE failed: ${J.status} ${J.statusText}`);if(!J.body)throw new Error("No body in SSE response");let w=J.body.pipeThrough(new TextDecoderStream).getReader(),U="",X=()=>{try{w.cancel()}catch{}};Y.addEventListener("abort",X);try{while(!0){let{done:Vc,value:Ec}=await w.read();if(Vc)break;U+=Ec;let A=U.split(`

`);U=A.pop()??"";for(let Gc of A){let Qc=Gc.split(`
`),F=[],l;for(let B of Qc)if(B.startsWith("data:"))F.push(B.replace(/^data:\s*/,""));else if(B.startsWith("event:"))l=B.replace(/^event:\s*/,"");else if(B.startsWith("id:"))S=B.replace(/^id:\s*/,"");else if(B.startsWith("retry:")){let C=Number.parseInt(B.replace(/^retry:\s*/,""),10);if(!Number.isNaN(C))N=C}let Z,_=!1;if(F.length){let B=F.join(`
`);try{Z=JSON.parse(B),_=!0}catch{Z=B}}if(_){if(O)await O(Z);if(f)Z=await f(Z)}if(r?.({data:Z,event:l,id:S,retry:N}),F.length)yield Z}}}finally{Y.removeEventListener("abort",X),w.releaseLock()}break}catch(J){if(c?.(J),m!==void 0&&z>=m)break;let w=Math.min(N*2**(z-1),u??30000);await W(w)}}}()}};var H=async(c,r)=>{let f=typeof r==="function"?await r(c):r;if(!f)return;if(c.scheme==="bearer")return`Bearer ${f}`;if(c.scheme==="basic")return`Basic ${btoa(f)}`;return f};var I={bodySerializer:(c)=>JSON.stringify(c,(r,f)=>typeof f==="bigint"?f.toString():f)};var Tc=(c)=>{switch(c){case"label":return".";case"matrix":return";";case"simple":return",";default:return"&"}},Fc=(c)=>{switch(c){case"form":return",";case"pipeDelimited":return"|";case"spaceDelimited":return"%20";default:return","}},Lc=(c)=>{switch(c){case"label":return".";case"matrix":return";";case"simple":return",";default:return"&"}},L=({allowReserved:c,explode:r,name:f,style:O,value:b})=>{if(!r){let x=(c?b:b.map((h)=>encodeURIComponent(h))).join(Fc(O));switch(O){case"label":return`.${x}`;case"matrix":return`;${f}=${x}`;case"simple":return x;default:return`${f}=${x}`}}let m=Tc(O),u=b.map((x)=>{if(O==="label"||O==="simple")return c?x:encodeURIComponent(x);return g({allowReserved:c,name:f,value:x})}).join(m);return O==="label"||O==="matrix"?m+u:u},g=({allowReserved:c,name:r,value:f})=>{if(f===void 0||f===null)return"";if(typeof f==="object")throw new Error("Deeply-nested arrays/objects aren’t supported. Provide your own `querySerializer()` to handle these.");return`${r}=${c?f:encodeURIComponent(f)}`},P=({allowReserved:c,explode:r,name:f,style:O,value:b,valueOnly:m})=>{if(b instanceof Date)return m?b.toISOString():`${f}=${b.toISOString()}`;if(O!=="deepObject"&&!r){let h=[];Object.entries(b).forEach(([S,W])=>{h=[...h,S,c?W:encodeURIComponent(W)]});let $=h.join(",");switch(O){case"form":return`${f}=${$}`;case"label":return`.${$}`;case"matrix":return`;${f}=${$}`;default:return $}}let u=Lc(O),x=Object.entries(b).map(([h,$])=>g({allowReserved:c,name:O==="deepObject"?`${f}[${h}]`:h,value:$})).join(u);return O==="label"||O==="matrix"?u+x:x};var Pc=/\{[^{}]+\}/g,Dc=({path:c,url:r})=>{let f=r,O=r.match(Pc);if(O)for(let b of O){let m=!1,u=b.substring(1,b.length-1),x="simple";if(u.endsWith("*"))m=!0,u=u.substring(0,u.length-1);if(u.startsWith("."))u=u.substring(1),x="label";else if(u.startsWith(";"))u=u.substring(1),x="matrix";let h=c[u];if(h===void 0||h===null)continue;if(Array.isArray(h)){f=f.replace(b,L({explode:m,name:u,style:x,value:h}));continue}if(typeof h==="object"){f=f.replace(b,P({explode:m,name:u,style:x,value:h,valueOnly:!0}));continue}if(x==="matrix"){f=f.replace(b,`;${g({name:u,value:h})}`);continue}let $=encodeURIComponent(x==="label"?`.${h}`:h);f=f.replace(b,$)}return f},v=({baseUrl:c,path:r,query:f,querySerializer:O,url:b})=>{let m=b.startsWith("/")?b:`/${b}`,u=(c??"")+m;if(r)u=Dc({path:r,url:u});let x=f?O(f):"";if(x.startsWith("?"))x=x.substring(1);if(x)u+=`?${x}`;return u};var e=({allowReserved:c,array:r,object:f}={})=>{return(b)=>{let m=[];if(b&&typeof b==="object")for(let u in b){let x=b[u];if(x===void 0||x===null)continue;if(Array.isArray(x)){let h=L({allowReserved:c,explode:!0,name:u,style:"form",value:x,...r});if(h)m.push(h)}else if(typeof x==="object"){let h=P({allowReserved:c,explode:!0,name:u,style:"deepObject",value:x,...f});if(h)m.push(h)}else{let h=g({allowReserved:c,name:u,value:x});if(h)m.push(h)}}return m.join("&")}},t=(c)=>{if(!c)return"stream";let r=c.split(";")[0]?.trim();if(!r)return;if(r.startsWith("application/json")||r.endsWith("+json"))return"json";if(r==="multipart/form-data")return"formData";if(["application/","audio/","image/","video/"].some((f)=>r.startsWith(f)))return"blob";if(r.startsWith("text/"))return"text";return},Mc=(c,r)=>{if(!r)return!1;if(c.headers.has(r)||c.query?.[r]||c.headers.get("Cookie")?.includes(`${r}=`))return!0;return!1},i=async({security:c,...r})=>{for(let f of c){if(Mc(r,f.name))continue;let O=await H(f,r.auth);if(!O)continue;let b=f.name??"Authorization";switch(f.in){case"query":if(!r.query)r.query={};r.query[b]=O;break;case"cookie":r.headers.append("Cookie",`${b}=${O}`);break;case"header":default:r.headers.set(b,O);break}}},R=(c)=>v({baseUrl:c.baseUrl,path:c.path,query:c.query,querySerializer:typeof c.querySerializer==="function"?c.querySerializer:e(c.querySerializer),url:c.url}),q=(c,r)=>{let f={...c,...r};if(f.baseUrl?.endsWith("/"))f.baseUrl=f.baseUrl.substring(0,f.baseUrl.length-1);return f.headers=M(c.headers,r.headers),f},M=(...c)=>{let r=new Headers;for(let f of c){if(!f||typeof f!=="object")continue;let O=f instanceof Headers?f.entries():Object.entries(f);for(let[b,m]of O)if(m===null)r.delete(b);else if(Array.isArray(m))for(let u of m)r.append(b,u);else if(m!==void 0)r.set(b,typeof m==="object"?JSON.stringify(m):m)}return r};class D{_fns;constructor(){this._fns=[]}clear(){this._fns=[]}getInterceptorIndex(c){if(typeof c==="number")return this._fns[c]?c:-1;else return this._fns.indexOf(c)}exists(c){let r=this.getInterceptorIndex(c);return!!this._fns[r]}eject(c){let r=this.getInterceptorIndex(c);if(this._fns[r])this._fns[r]=null}update(c,r){let f=this.getInterceptorIndex(c);if(this._fns[f])return this._fns[f]=r,c;else return!1}use(c){return this._fns=[...this._fns,c],this._fns.length-1}}var n=()=>({error:new D,request:new D,response:new D}),Ic=e({allowReserved:!1,array:{explode:!0,style:"form"},object:{explode:!0,style:"deepObject"}}),Rc={"Content-Type":"application/json"},G=(c={})=>({...I,headers:Rc,parseAs:"auto",querySerializer:Ic,...c});var Q=(c={})=>{let r=q(G(),c),f=()=>({...r}),O=(h)=>{return r=q(r,h),f()},b=n(),m=async(h)=>{let $={...r,...h,fetch:h.fetch??r.fetch??globalThis.fetch,headers:M(r.headers,h.headers),serializedBody:void 0};if($.security)await i({...$,security:$.security});if($.requestValidator)await $.requestValidator($);if($.body&&$.bodySerializer)$.serializedBody=$.bodySerializer($.body);if($.serializedBody===void 0||$.serializedBody==="")$.headers.delete("Content-Type");let S=R($);return{opts:$,url:S}},u=async(h)=>{let{opts:$,url:S}=await m(h),W={redirect:"follow",...$,body:$.serializedBody},K=new Request(S,W);for(let U of b.request._fns)if(U)K=await U(K,$);let y=$.fetch,N=await y(K);for(let U of b.response._fns)if(U)N=await U(N,K,$);let z={request:K,response:N};if(N.ok){if(N.status===204||N.headers.get("Content-Length")==="0")return $.responseStyle==="data"?{}:{data:{},...z};let U=($.parseAs==="auto"?t(N.headers.get("Content-Type")):$.parseAs)??"json",X;switch(U){case"arrayBuffer":case"blob":case"formData":case"json":case"text":X=await N[U]();break;case"stream":return $.responseStyle==="data"?N.body:{data:N.body,...z}}if(U==="json"){if($.responseValidator)await $.responseValidator(X);if($.responseTransformer)X=await $.responseTransformer(X)}return $.responseStyle==="data"?X:{data:X,...z}}let Y=await N.text(),E;try{E=JSON.parse(Y)}catch{}let J=E??Y,w=J;for(let U of b.error._fns)if(U)w=await U(J,N,K,$);if(w=w||{},$.throwOnError)throw w;return $.responseStyle==="data"?void 0:{error:w,...z}},x=(h)=>{let $=(S)=>u({...S,method:h});return $.sse=async(S)=>{let{opts:W,url:K}=await m(S);return d({...W,body:W.body,headers:W.headers,method:h,url:K})},$};return{buildUrl:R,connect:x("CONNECT"),delete:x("DELETE"),get:x("GET"),getConfig:f,head:x("HEAD"),interceptors:b,options:x("OPTIONS"),patch:x("PATCH"),post:x("POST"),put:x("PUT"),request:u,setConfig:O,trace:x("TRACE")}};var qc={$body_:"body",$headers_:"headers",$path_:"path",$query_:"query"},rr=Object.entries(qc);var p=Q(G({baseUrl:"http://localhost:4096"}));class j{_client=p;constructor(c){if(c?.client)this._client=c.client}}class s extends j{event(c){return(c?.client??this._client).get.sse({url:"/global/event",...c})}}class o extends j{list(c){return(c?.client??this._client).get({url:"/project",...c})}current(c){return(c?.client??this._client).get({url:"/project/current",...c})}}class cc extends j{list(c){return(c?.client??this._client).get({url:"/pty",...c})}create(c){return(c?.client??this._client).post({url:"/pty",...c,headers:{"Content-Type":"application/json",...c?.headers}})}remove(c){return(c.client??this._client).delete({url:"/pty/{id}",...c})}get(c){return(c.client??this._client).get({url:"/pty/{id}",...c})}update(c){return(c.client??this._client).put({url:"/pty/{id}",...c,headers:{"Content-Type":"application/json",...c.headers}})}connect(c){return(c.client??this._client).get({url:"/pty/{id}/connect",...c})}}class rc extends j{get(c){return(c?.client??this._client).get({url:"/config",...c})}update(c){return(c?.client??this._client).patch({url:"/config",...c,headers:{"Content-Type":"application/json",...c?.headers}})}providers(c){return(c?.client??this._client).get({url:"/config/providers",...c})}}class fc extends j{ids(c){return(c?.client??this._client).get({url:"/experimental/tool/ids",...c})}list(c){return(c.client??this._client).get({url:"/experimental/tool",...c})}}class $c extends j{dispose(c){return(c?.client??this._client).post({url:"/instance/dispose",...c})}}class bc extends j{get(c){return(c?.client??this._client).get({url:"/path",...c})}}class xc extends j{get(c){return(c?.client??this._client).get({url:"/vcs",...c})}}class hc extends j{list(c){return(c?.client??this._client).get({url:"/session",...c})}create(c){return(c?.client??this._client).post({url:"/session",...c,headers:{"Content-Type":"application/json",...c?.headers}})}status(c){return(c?.client??this._client).get({url:"/session/status",...c})}delete(c){return(c.client??this._client).delete({url:"/session/{id}",...c})}get(c){return(c.client??this._client).get({url:"/session/{id}",...c})}update(c){return(c.client??this._client).patch({url:"/session/{id}",...c,headers:{"Content-Type":"application/json",...c.headers}})}children(c){return(c.client??this._client).get({url:"/session/{id}/children",...c})}todo(c){return(c.client??this._client).get({url:"/session/{id}/todo",...c})}init(c){return(c.client??this._client).post({url:"/session/{id}/init",...c,headers:{"Content-Type":"application/json",...c.headers}})}fork(c){return(c.client??this._client).post({url:"/session/{id}/fork",...c,headers:{"Content-Type":"application/json",...c.headers}})}abort(c){return(c.client??this._client).post({url:"/session/{id}/abort",...c})}unshare(c){return(c.client??this._client).delete({url:"/session/{id}/share",...c})}share(c){return(c.client??this._client).post({url:"/session/{id}/share",...c})}diff(c){return(c.client??this._client).get({url:"/session/{id}/diff",...c})}summarize(c){return(c.client??this._client).post({url:"/session/{id}/summarize",...c,headers:{"Content-Type":"application/json",...c.headers}})}messages(c){return(c.client??this._client).get({url:"/session/{id}/message",...c})}prompt(c){return(c.client??this._client).post({url:"/session/{id}/message",...c,headers:{"Content-Type":"application/json",...c.headers}})}message(c){return(c.client??this._client).get({url:"/session/{id}/message/{messageID}",...c})}promptAsync(c){return(c.client??this._client).post({url:"/session/{id}/prompt_async",...c,headers:{"Content-Type":"application/json",...c.headers}})}command(c){return(c.client??this._client).post({url:"/session/{id}/command",...c,headers:{"Content-Type":"application/json",...c.headers}})}shell(c){return(c.client??this._client).post({url:"/session/{id}/shell",...c,headers:{"Content-Type":"application/json",...c.headers}})}revert(c){return(c.client??this._client).post({url:"/session/{id}/revert",...c,headers:{"Content-Type":"application/json",...c.headers}})}unrevert(c){return(c.client??this._client).post({url:"/session/{id}/unrevert",...c})}}class uc extends j{list(c){return(c?.client??this._client).get({url:"/command",...c})}}class Oc extends j{authorize(c){return(c.client??this._client).post({url:"/provider/{id}/oauth/authorize",...c,headers:{"Content-Type":"application/json",...c.headers}})}callback(c){return(c.client??this._client).post({url:"/provider/{id}/oauth/callback",...c,headers:{"Content-Type":"application/json",...c.headers}})}}class mc extends j{list(c){return(c?.client??this._client).get({url:"/provider",...c})}auth(c){return(c?.client??this._client).get({url:"/provider/auth",...c})}oauth=new Oc({client:this._client})}class jc extends j{text(c){return(c.client??this._client).get({url:"/find",...c})}files(c){return(c.client??this._client).get({url:"/find/file",...c})}symbols(c){return(c.client??this._client).get({url:"/find/symbol",...c})}}class Nc extends j{list(c){return(c.client??this._client).get({url:"/file",...c})}read(c){return(c.client??this._client).get({url:"/file/content",...c})}status(c){return(c?.client??this._client).get({url:"/file/status",...c})}}class Sc extends j{log(c){return(c?.client??this._client).post({url:"/log",...c,headers:{"Content-Type":"application/json",...c?.headers}})}agents(c){return(c?.client??this._client).get({url:"/agent",...c})}}class Uc extends j{status(c){return(c?.client??this._client).get({url:"/mcp",...c})}add(c){return(c?.client??this._client).post({url:"/mcp",...c,headers:{"Content-Type":"application/json",...c?.headers}})}}class wc extends j{status(c){return(c?.client??this._client).get({url:"/lsp",...c})}}class Bc extends j{status(c){return(c?.client??this._client).get({url:"/formatter",...c})}}class Wc extends j{next(c){return(c?.client??this._client).get({url:"/tui/control/next",...c})}response(c){return(c?.client??this._client).post({url:"/tui/control/response",...c,headers:{"Content-Type":"application/json",...c?.headers}})}}class zc extends j{appendPrompt(c){return(c?.client??this._client).post({url:"/tui/append-prompt",...c,headers:{"Content-Type":"application/json",...c?.headers}})}openHelp(c){return(c?.client??this._client).post({url:"/tui/open-help",...c})}openSessions(c){return(c?.client??this._client).post({url:"/tui/open-sessions",...c})}openThemes(c){return(c?.client??this._client).post({url:"/tui/open-themes",...c})}openModels(c){return(c?.client??this._client).post({url:"/tui/open-models",...c})}submitPrompt(c){return(c?.client??this._client).post({url:"/tui/submit-prompt",...c})}clearPrompt(c){return(c?.client??this._client).post({url:"/tui/clear-prompt",...c})}executeCommand(c){return(c?.client??this._client).post({url:"/tui/execute-command",...c,headers:{"Content-Type":"application/json",...c?.headers}})}showToast(c){return(c?.client??this._client).post({url:"/tui/show-toast",...c,headers:{"Content-Type":"application/json",...c?.headers}})}publish(c){return(c?.client??this._client).post({url:"/tui/publish",...c,headers:{"Content-Type":"application/json",...c?.headers}})}control=new Wc({client:this._client})}class Jc extends j{set(c){return(c.client??this._client).put({url:"/auth/{id}",...c,headers:{"Content-Type":"application/json",...c.headers}})}}class Kc extends j{subscribe(c){return(c?.client??this._client).get.sse({url:"/event",...c})}}class k extends j{postSessionIdPermissionsPermissionId(c){return(c.client??this._client).post({url:"/session/{id}/permissions/{permissionID}",...c,headers:{"Content-Type":"application/json",...c.headers}})}global=new s({client:this._client});project=new o({client:this._client});pty=new cc({client:this._client});config=new rc({client:this._client});tool=new fc({client:this._client});instance=new $c({client:this._client});path=new bc({client:this._client});vcs=new xc({client:this._client});session=new hc({client:this._client});command=new uc({client:this._client});provider=new mc({client:this._client});find=new jc({client:this._client});file=new Nc({client:this._client});app=new Sc({client:this._client});mcp=new Uc({client:this._client});lsp=new wc({client:this._client});formatter=new Bc({client:this._client});tui=new zc({client:this._client});auth=new Jc({client:this._client});event=new Kc({client:this._client})}function Xc(c){if(!c?.fetch)c={...c,fetch:(f)=>{return f.timeout=!1,fetch(f)}};if(c?.directory)c.headers={...c.headers,"x-opencode-directory":c.directory};let r=Q(c);return new k({client:r})}import{spawn as kc}from"node:child_process";async function Yc(c){c=Object.assign({hostname:"127.0.0.1",port:4096,timeout:5000},c??{});let r=kc("opencode",["serve",`--hostname=${c.hostname}`,`--port=${c.port}`],{signal:c.signal,env:{...process.env,OPENCODE_CONFIG_CONTENT:JSON.stringify(c.config??{})}});return{url:await new Promise((O,b)=>{let m=setTimeout(()=>{b(new Error(`Timeout waiting for server to start after ${c.timeout}ms`))},c.timeout),u="";if(r.stdout?.on("data",(x)=>{u+=x.toString();let h=u.split(`
`);for(let $ of h)if($.startsWith("opencode server listening")){let S=$.match(/on\s+(https?:\/\/[^\s]+)/);if(!S)throw new Error(`Failed to parse server url from output: ${$}`);clearTimeout(m),O(S[1]);return}}),r.stderr?.on("data",(x)=>{u+=x.toString()}),r.on("exit",(x)=>{clearTimeout(m);let h=`Server exited with code ${x}`;if(u.trim())h+=`
Server output: ${u}`;b(new Error(h))}),r.on("error",(x)=>{clearTimeout(m),b(x)}),c.signal)c.signal.addEventListener("abort",()=>{clearTimeout(m),b(new Error("Aborted"))})}),close(){r.kill()}}}async function Zc(c){let r=await Yc({...c});return{client:Xc({baseUrl:r.url}),server:r}}var a=parseInt(process.env.BRIDGE_PORT||"8004"),ac=parseInt(process.env.OPENCODE_PORT||"8998"),T=null,V=null;async function yc(){if(T)return T;console.log("\uD83D\uDE80 Starting OpenCode server...");let{client:c,server:r}=await Zc({hostname:"127.0.0.1",port:ac});return T=c,console.log(`✅ OpenCode server running at ${r.url}`),c}async function gc(){if(V)return V;let c=await yc();return console.log("\uD83D\uDD27 Creating OpenCode session..."),V=(await c.session.create({})).data?.id||null,console.log(`✅ OpenCode session created: ${V}`),V}async function Ac(c){let r=await gc();if(!r||!T)throw new Error("Failed to initialize OpenCode session");return((await T.session.prompt({path:{id:r},body:{parts:[{type:"text",text:c}]}})).data?.parts||[]).filter((b)=>b.type==="text").map((b)=>("text"in b?b.text:"")||"").join(`
`)}await gc();Bun.serve({port:a,fetch(c,r){let f=new URL(c.url);if(f.pathname==="/ws"){if(!r.upgrade(c))return new Response("WebSocket upgrade failed",{status:400});return}if(f.pathname==="/health")return Response.json({status:"ok",sessionId:V});return new Response("Not found",{status:404})},websocket:{open(c){console.log("\uD83D\uDD0C Client connected")},async message(c,r){try{let f=JSON.parse(r.toString());if(f.type==="message"){let O=f.content;console.log(`\uD83D\uDCE5 Task: ${O.substring(0,100)}...`);let b=await Ac(O);c.send(JSON.stringify({type:"response",content:b})),console.log("\uD83D\uDCE4 Response sent")}}catch(f){console.error("❌ Error:",f),c.send(JSON.stringify({type:"response",content:`Error: ${f instanceof Error?f.message:"Unknown error"}`}))}},close(c){console.log("\uD83D\uDCF4 Client disconnected")}}});console.log(`\uD83C\uDF09 OpenCode Bridge ready on port ${a}`);console.log(`   WebSocket: ws://localhost:${a}/ws`);
